<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="××©×™××•×ª">
<meta name="theme-color" content="#ffffff">
<title>×× ×”×œ ××©×™××•×ª</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html {
    overscroll-behavior: none;
    -webkit-tap-highlight-color: transparent;
  }
  body {
    font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
    background: #FFCFDE;
    color: #333;
    min-height: 100vh;
    min-height: 100dvh;
    direction: rtl;
    overscroll-behavior: none;
    -webkit-user-select: none;
    user-select: none;
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
  }
  input, textarea, select { -webkit-user-select: auto; user-select: auto; }

  .header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    padding-top: env(safe-area-inset-top);
  }
  .header h1 {
    text-align: center;
    padding: 12px 0 4px;
    font-size: 1.3rem;
    color: #c0467e;
  }
  .tabs {
    display: flex;
  }
  .tab-btn {
    flex: 1;
    padding: 12px 8px;
    border: none;
    background: #fff;
    font-size: 1rem;
    font-weight: 600;
    color: #999;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: all .2s;
  }
  .tab-btn.active {
    color: #c0467e;
    border-bottom-color: #c0467e;
  }

  .container {
    max-width: 600px;
    margin: 0 auto;
    padding: 12px;
    padding-left: max(12px, env(safe-area-inset-left));
    padding-right: max(12px, env(safe-area-inset-right));
    padding-bottom: 24px;
  }

  /* ---- Tasks Tab ---- */
  .add-task-form {
    background: #fff;
    border-radius: 14px;
    padding: 14px;
    margin-bottom: 14px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  }
  .add-task-form input,
  .add-task-form textarea,
  .add-task-form select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #e0c0cc;
    border-radius: 10px;
    font-size: .95rem;
    margin-bottom: 8px;
    font-family: inherit;
    direction: rtl;
  }
  .add-task-form textarea { resize: vertical; min-height: 50px; }
  .form-row {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
  }
  .form-row select { flex: 1; min-width: 0; }
  .recurring-label {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: .9rem;
    cursor: pointer;
    white-space: nowrap;
  }
  .recurring-label input { width: auto; margin: 0; }
  .btn {
    padding: 10px 20px;
    border: none;
    border-radius: 10px;
    font-size: .95rem;
    font-weight: 600;
    cursor: pointer;
    transition: opacity .2s;
  }
  .btn:active { opacity: .7; }
  .btn-primary { background: #c0467e; color: #fff; }
  .btn-sm {
    padding: 6px 12px;
    font-size: .85rem;
    border-radius: 8px;
  }

  .task-card {
    background: #fff;
    border-radius: 14px;
    padding: 14px;
    margin-bottom: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    display: flex;
    align-items: flex-start;
    gap: 10px;
    border-right: 5px solid #7eaef1;
  }
  .task-card.priority-urgent { border-right-color: #e74c3c; }
  .task-card.priority-important { border-right-color: #f39c12; }
  .task-card.priority-regular { border-right-color: #7eaef1; }
  .task-card.done .task-title { text-decoration: line-through; color: #aaa; }
  .task-card.done .task-desc { text-decoration: line-through; color: #bbb; }

  .task-check {
    width: 32px; height: 32px;
    border-radius: 50%;
    border: 2px solid #ccc;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    flex-shrink: 0;
    font-weight: 700;
    font-size: 1rem;
    color: transparent;
    transition: all .2s;
    background: #fff;
  }
  .task-card.done .task-check {
    background: #27ae60;
    border-color: #27ae60;
    color: #fff;
  }
  .task-body { flex: 1; min-width: 0; }
  .task-title { font-weight: 600; font-size: 1rem; word-break: break-word; }
  .task-desc { font-size: .85rem; color: #777; margin-top: 2px; word-break: break-word; }
  .task-badges { display: flex; gap: 6px; margin-top: 6px; flex-wrap: wrap; }
  .badge {
    font-size: .75rem;
    padding: 2px 8px;
    border-radius: 6px;
    font-weight: 600;
  }
  .badge-urgent { background: #fde2e2; color: #e74c3c; }
  .badge-important { background: #fef3e0; color: #e67e22; }
  .badge-regular { background: #e0eeff; color: #3e7ec0; }
  .badge-recurring { background: #e8f5e9; color: #388e3c; }
  .badge-reminder { background: #f3e5f5; color: #8e24aa; }

  .task-delete {
    background: none; border: none; font-size: 1.2rem; color: #ccc;
    cursor: pointer; padding: 4px; flex-shrink: 0;
  }
  .task-delete:hover { color: #e74c3c; }

  /* ---- Events Tab ---- */
  .week-nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #fff;
    border-radius: 14px;
    padding: 10px 14px;
    margin-bottom: 14px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  }
  .week-nav button {
    background: #c0467e; color: #fff; border: none;
    border-radius: 8px; padding: 6px 14px; font-size: 1rem;
    cursor: pointer;
  }
  .week-nav span { font-weight: 600; font-size: .95rem; }

  .add-event-form {
    background: #fff;
    border-radius: 14px;
    padding: 14px;
    margin-bottom: 14px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  }
  .add-event-form input,
  .add-event-form select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #e0c0cc;
    border-radius: 10px;
    font-size: .95rem;
    margin-bottom: 8px;
    font-family: inherit;
    direction: rtl;
  }
  .event-form-row {
    display: flex;
    gap: 8px;
  }
  .event-form-row select,
  .event-form-row input { flex: 1; min-width: 0; }

  .day-card {
    background: #fff;
    border-radius: 14px;
    margin-bottom: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    overflow: hidden;
  }
  .day-header {
    background: #f8e0ea;
    padding: 10px 14px;
    font-weight: 700;
    font-size: .95rem;
    color: #c0467e;
  }
  .day-header.today { background: #c0467e; color: #fff; }
  .event-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 14px;
    border-bottom: 1px solid #f5f0f2;
    gap: 8px;
  }
  .event-item:last-child { border-bottom: none; }
  .event-time { font-weight: 600; font-size: .9rem; color: #c0467e; white-space: nowrap; }
  .event-title-text { flex: 1; font-size: .95rem; word-break: break-word; }
  .event-notify-badge {
    font-size: .7rem; padding: 1px 6px; border-radius: 5px;
    background: #f3e5f5; color: #8e24aa; font-weight: 600; white-space: nowrap;
  }
  .event-delete {
    background: none; border: none; color: #ccc; font-size: 1.1rem;
    cursor: pointer; padding: 4px;
  }
  .event-delete:hover { color: #e74c3c; }
  .no-events { padding: 10px 14px; color: #bbb; font-size: .85rem; }

  .tab-content { display: none; }
  .tab-content.active { display: block; }

  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #c0a0b0;
    font-size: .95rem;
  }
</style>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-messaging-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
</head>
<body>

<div class="header">
  <h1>×× ×”×œ ××©×™××•×ª</h1>
  <div class="tabs">
    <button class="tab-btn active" data-tab="events">×™×•××Ÿ ××™×¨×•×¢×™× ×©×‘×•×¢×™</button>
    <button class="tab-btn" data-tab="tasks">××©×™××•×ª ×©×‘×•×¢×™×•×ª</button>
  </div>
</div>

<!-- Events Tab -->
<div id="tab-events" class="tab-content active">
  <div class="container">
    <div class="week-nav">
      <button id="prevWeek">â†’</button>
      <span id="weekLabel"></span>
      <button id="nextWeek">â†</button>
    </div>
    <div class="add-event-form">
      <input type="text" id="eventTitle" placeholder="×›×•×ª×¨×ª ××™×¨×•×¢">
      <div class="event-form-row">
        <select id="eventDay"></select>
        <input type="time" id="eventTime">
      </div>
      <div class="event-form-row" style="margin-top:0;">
        <label style="font-size:.85rem;color:#8e24aa;white-space:nowrap;display:flex;align-items:center;gap:4px;">
          <input type="checkbox" id="eventNotifyToggle" style="width:auto;margin:0;"> ×”×ª×¨××”
        </label>
        <input type="number" id="eventNotifyMinutes" placeholder="×“×§×•×ª ×œ×¤× ×™" min="0" value="15" style="flex:1;min-width:0;">
      </div>
      <button class="btn btn-primary" id="addEventBtn" style="width:100%;margin-top:4px;">×”×•×¡×£ ××™×¨×•×¢</button>
    </div>
    <div id="weekView"></div>
  </div>
</div>

<!-- Tasks Tab -->
<div id="tab-tasks" class="tab-content">
  <div class="container">
    <div class="add-task-form">
      <input type="text" id="taskTitle" placeholder="×›×•×ª×¨×ª ××©×™××”">
      <textarea id="taskDesc" placeholder="×ª×™××•×¨ (××•×¤×¦×™×•× ×œ×™)"></textarea>
      <div class="form-row">
        <select id="taskPriority">
          <option value="urgent">×“×—×•×£</option>
          <option value="important">×—×©×•×‘</option>
          <option value="regular" selected>×¨×’×™×œ</option>
        </select>
        <label class="recurring-label">
          <input type="checkbox" id="taskRecurring"> ×—×•×–×¨
        </label>
      </div>
      <div class="form-row" style="margin-top:4px;align-items:center;">
        <label style="font-size:.85rem;color:#8e24aa;white-space:nowrap;">ğŸ”” ×”×ª×¨××”:</label>
        <input type="datetime-local" id="taskReminder" style="flex:1;min-width:0;">
        <button class="btn btn-primary" id="addTaskBtn">×”×•×¡×£</button>
      </div>
    </div>
    <div id="taskList"></div>
  </div>
</div>

<script>
// ---- Constants ----
var HEB_DAYS = ['×¨××©×•×Ÿ','×©× ×™','×©×œ×™×©×™','×¨×‘×™×¢×™','×—××™×©×™','×©×™×©×™','×©×‘×ª'];
var PRIORITY_MAP = {
  urgent: { label: '×“×—×•×£', cls: 'urgent' },
  important: { label: '×—×©×•×‘', cls: 'important' },
  regular: { label: '×¨×’×™×œ', cls: 'regular' }
};

// ---- Helpers ----
function esc(s) {
  var d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// Local date string YYYY-MM-DD (fixes timezone bug with toISOString)
function localDateStr(d) {
  var y = d.getFullYear();
  var m = String(d.getMonth() + 1).padStart(2, '0');
  var day = String(d.getDate()).padStart(2, '0');
  return y + '-' + m + '-' + day;
}

function formatDate(d) {
  return d.getDate() + '/' + (d.getMonth() + 1);
}

function formatReminderDisplay(dtStr) {
  var d = new Date(dtStr);
  return d.getDate() + '/' + (d.getMonth() + 1) + ' ' +
    String(d.getHours()).padStart(2, '0') + ':' + String(d.getMinutes()).padStart(2, '0');
}

// ---- State ----
var currentWeekStart = getWeekStart(new Date());

function getWeekStart(date) {
  var d = new Date(date);
  d.setDate(d.getDate() - d.getDay());
  d.setHours(0, 0, 0, 0);
  return d;
}

function weekKey(date) {
  return localDateStr(date);
}

// ---- Storage ----
function loadTasks() {
  try { return JSON.parse(localStorage.getItem('tm_tasks')) || []; }
  catch(e) { return []; }
}
function saveTasks(tasks) {
  try { localStorage.setItem('tm_tasks', JSON.stringify(tasks)); } catch(e) {}
}
function loadEvents() {
  try { return JSON.parse(localStorage.getItem('tm_events')) || {}; }
  catch(e) { return {}; }
}
function saveEvents(events) {
  try { localStorage.setItem('tm_events', JSON.stringify(events)); } catch(e) {}
}

// ---- Tabs (event delegation on header) ----
document.querySelector('.tabs').addEventListener('click', function(e) {
  var btn = e.target.closest('.tab-btn');
  if (!btn) return;
  e.preventDefault();
  e.stopPropagation();
  document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
  document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
  btn.classList.add('active');
  document.getElementById('tab-' + btn.getAttribute('data-tab')).classList.add('active');
});

// ---- Tasks (event delegation) ----
document.getElementById('taskList').addEventListener('click', function(e) {
  e.preventDefault();
  e.stopPropagation();
  var check = e.target.closest('.task-check');
  if (check) {
    var card = check.closest('.task-card');
    if (card) toggleTask(card.getAttribute('data-id'));
    return;
  }
  var del = e.target.closest('.task-delete');
  if (del) {
    var card = del.closest('.task-card');
    if (card) deleteTask(card.getAttribute('data-id'));
    return;
  }
});

function renderTasks() {
  var tasks = loadTasks();
  var list = document.getElementById('taskList');
  if (!tasks.length) {
    list.innerHTML = '<div class="empty-state">××™×Ÿ ××©×™××•×ª ×¢×“×™×™×Ÿ</div>';
    return;
  }
  var order = { urgent: 0, important: 1, regular: 2 };
  var sorted = tasks.slice().sort(function(a, b) {
    if (a.done !== b.done) return a.done ? 1 : -1;
    return (order[a.priority] || 2) - (order[b.priority] || 2);
  });
  list.innerHTML = sorted.map(function(t) {
    var p = PRIORITY_MAP[t.priority] || PRIORITY_MAP.regular;
    var reminderBadge = '';
    if (t.reminder && !t.done) {
      var isPast = new Date(t.reminder) < new Date();
      reminderBadge = '<span class="badge badge-reminder">' + (isPast ? 'â° ×¢×‘×¨ ' : 'â° ') + formatReminderDisplay(t.reminder) + '</span>';
    }
    return '<div class="task-card priority-' + p.cls + (t.done ? ' done' : '') + '" data-id="' + t.id + '">' +
      '<div class="task-check">V</div>' +
      '<div class="task-body">' +
        '<div class="task-title">' + esc(t.title) + '</div>' +
        (t.desc ? '<div class="task-desc">' + esc(t.desc) + '</div>' : '') +
        '<div class="task-badges">' +
          '<span class="badge badge-' + p.cls + '">' + p.label + '</span>' +
          (t.recurring ? '<span class="badge badge-recurring">×—×•×–×¨</span>' : '') +
          reminderBadge +
        '</div>' +
      '</div>' +
      '<button class="task-delete" type="button">âœ•</button>' +
    '</div>';
  }).join('');
}

function addTask() {
  var title = document.getElementById('taskTitle').value.trim();
  if (!title) return;
  var tasks = loadTasks();
  var reminder = document.getElementById('taskReminder').value || '';
  var desc = document.getElementById('taskDesc').value.trim();
  var cloudKey = null;
  if (reminder) {
    cloudKey = saveReminderToCloud('×ª×–×›×•×¨×ª ××©×™××”: ' + title, desc || '×”×’×™×¢ ×”×–××Ÿ ×œ×˜×¤×œ ×‘××©×™××” ×–×•', new Date(reminder).getTime());
  }
  tasks.push({
    id: Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
    title: title,
    desc: desc,
    priority: document.getElementById('taskPriority').value,
    recurring: document.getElementById('taskRecurring').checked,
    reminder: reminder,
    reminderSent: false,
    reminderKey: cloudKey,
    done: false
  });
  saveTasks(tasks);
  document.getElementById('taskTitle').value = '';
  document.getElementById('taskDesc').value = '';
  document.getElementById('taskRecurring').checked = false;
  document.getElementById('taskPriority').value = 'regular';
  document.getElementById('taskReminder').value = '';
  renderTasks();
}

function toggleTask(id) {
  var tasks = loadTasks();
  var t = tasks.find(function(x) { return x.id === id; });
  if (t) t.done = !t.done;
  saveTasks(tasks);
  renderTasks();
}

function deleteTask(id) {
  var tasks = loadTasks();
  var task = tasks.find(function(x) { return x.id === id; });
  if (task && task.reminderKey) removeReminderFromCloud(task.reminderKey);
  saveTasks(tasks.filter(function(x) { return x.id !== id; }));
  renderTasks();
}

document.getElementById('addTaskBtn').addEventListener('click', function(e) {
  e.preventDefault();
  addTask();
});
document.getElementById('taskTitle').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') { e.preventDefault(); addTask(); }
});

// ---- Events (event delegation) ----
document.getElementById('weekView').addEventListener('click', function(e) {
  var del = e.target.closest('.event-delete');
  if (!del) return;
  e.preventDefault();
  e.stopPropagation();
  var wk = del.getAttribute('data-wk');
  var day = parseInt(del.getAttribute('data-day'));
  var id = del.getAttribute('data-eid');
  deleteEvent(wk, day, id);
});

function populateDaySelect() {
  var sel = document.getElementById('eventDay');
  sel.innerHTML = HEB_DAYS.map(function(name, i) {
    return '<option value="' + i + '">×™×•× ' + name + '</option>';
  }).join('');
}
populateDaySelect();

function renderWeek() {
  var wk = weekKey(currentWeekStart);
  var end = new Date(currentWeekStart);
  end.setDate(end.getDate() + 6);
  document.getElementById('weekLabel').textContent =
    formatDate(currentWeekStart) + ' - ' + formatDate(end);

  var events = loadEvents();
  var weekEvents = events[wk] || {};
  var todayStr = localDateStr(new Date());
  var view = document.getElementById('weekView');

  var html = '';
  for (var i = 0; i < 7; i++) {
    var dayDate = new Date(currentWeekStart);
    dayDate.setDate(dayDate.getDate() + i);
    var dayStr = localDateStr(dayDate);
    var isToday = dayStr === todayStr;
    var dayEvents = (weekEvents[i] || []).slice().sort(function(a, b) {
      return (a.time || '').localeCompare(b.time || '');
    });

    html += '<div class="day-card">' +
      '<div class="day-header' + (isToday ? ' today' : '') + '">×™×•× ' + HEB_DAYS[i] + ' - ' + formatDate(dayDate) + '</div>';
    if (dayEvents.length) {
      html += dayEvents.map(function(ev) {
        var notifyTag = '';
        if (ev.notifyMinutes >= 0 && ev.notifyEnabled) {
          notifyTag = '<span class="event-notify-badge">ğŸ”” ' + ev.notifyMinutes + ' ×“×§×³</span>';
        }
        return '<div class="event-item">' +
          '<span class="event-time">' + (ev.time || '--:--') + '</span>' +
          '<span class="event-title-text">' + esc(ev.title) + ' ' + notifyTag + '</span>' +
          '<button class="event-delete" type="button" data-wk="' + wk + '" data-day="' + i + '" data-eid="' + ev.id + '">âœ•</button>' +
        '</div>';
      }).join('');
    } else {
      html += '<div class="no-events">××™×Ÿ ××™×¨×•×¢×™×</div>';
    }
    html += '</div>';
  }
  view.innerHTML = html;
}

function addEvent() {
  var title = document.getElementById('eventTitle').value.trim();
  if (!title) return;
  var day = parseInt(document.getElementById('eventDay').value);
  var time = document.getElementById('eventTime').value;
  var wk = weekKey(currentWeekStart);
  var events = loadEvents();
  if (!events[wk]) events[wk] = {};
  if (!events[wk][day]) events[wk][day] = [];
  var notifyEnabled = document.getElementById('eventNotifyToggle').checked;
  var notifyMinutes = parseInt(document.getElementById('eventNotifyMinutes').value) || 0;
  var evId = Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
  var cloudKey = null;
  if (notifyEnabled && time) {
    var eventDate = new Date(currentWeekStart);
    eventDate.setDate(eventDate.getDate() + day);
    var timeParts = time.split(':');
    eventDate.setHours(parseInt(timeParts[0]), parseInt(timeParts[1]), 0, 0);
    var notifyAt = eventDate.getTime() - notifyMinutes * 60000;
    cloudKey = saveReminderToCloud('××™×¨×•×¢ ×‘×¢×•×“ ' + notifyMinutes + ' ×“×§×•×ª', title, notifyAt);
  }
  events[wk][day].push({
    id: evId,
    title: title,
    time: time,
    notifyEnabled: notifyEnabled,
    notifyMinutes: notifyMinutes,
    notifySent: false,
    reminderKey: cloudKey
  });
  saveEvents(events);
  document.getElementById('eventTitle').value = '';
  document.getElementById('eventTime').value = '';
  document.getElementById('eventNotifyToggle').checked = false;
  document.getElementById('eventNotifyMinutes').value = '15';
  renderWeek();
}

function deleteEvent(wk, day, id) {
  var events = loadEvents();
  if (events[wk] && events[wk][day]) {
    var ev = events[wk][day].find(function(e) { return e.id === id; });
    if (ev && ev.reminderKey) removeReminderFromCloud(ev.reminderKey);
    events[wk][day] = events[wk][day].filter(function(e) { return e.id !== id; });
    if (!events[wk][day].length) delete events[wk][day];
    if (!Object.keys(events[wk]).length) delete events[wk];
  }
  saveEvents(events);
  renderWeek();
}

document.getElementById('addEventBtn').addEventListener('click', function(e) {
  e.preventDefault();
  addEvent();
});
document.getElementById('eventTitle').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') { e.preventDefault(); addEvent(); }
});

document.getElementById('prevWeek').addEventListener('click', function(e) {
  e.preventDefault();
  currentWeekStart.setDate(currentWeekStart.getDate() - 7);
  renderWeek();
});
document.getElementById('nextWeek').addEventListener('click', function(e) {
  e.preventDefault();
  currentWeekStart.setDate(currentWeekStart.getDate() + 7);
  renderWeek();
});

// ---- Firebase + Push Notifications ----
firebase.initializeApp({
  apiKey: "AIzaSyCl91EW0vWjt4fbwCVEQn5xLjPNlR-_5LA",
  authDomain: "oshaer-f2ae1.firebaseapp.com",
  databaseURL: "https://oshaer-f2ae1-default-rtdb.firebaseio.com",
  projectId: "oshaer-f2ae1",
  storageBucket: "oshaer-f2ae1.firebasestorage.app",
  messagingSenderId: "64655933064",
  appId: "1:64655933064:web:6e86cb0640ff6a2c3da93d"
});

var fbMessaging = firebase.messaging();
var fbDatabase = firebase.database();
var fcmToken = null;
var swRegistration = null;

function saveReminderToCloud(title, body, timeMs) {
  try {
    if (!fcmToken) return null;
    var ref = fbDatabase.ref('reminders').push({
      token: fcmToken,
      title: title,
      body: body,
      time: timeMs,
      sent: false
    });
    return ref.key;
  } catch(e) { return null; }
}

function removeReminderFromCloud(key) {
  try {
    if (key) fbDatabase.ref('reminders/' + key).remove();
  } catch(e) {}
}

function initFCM() {
  if (!('serviceWorker' in navigator) || !('Notification' in window)) return;

  navigator.serviceWorker.register('./sw.js').then(function(reg) {
    swRegistration = reg;

    // Handle foreground messages (show notification even when page is visible)
    fbMessaging.onMessage(function(payload) {
      var title = payload.notification ? payload.notification.title : '×ª×–×›×•×¨×ª';
      var body = payload.notification ? payload.notification.body : '';
      reg.showNotification(title, {
        body: body,
        vibrate: [200, 100, 200],
        tag: 'reminder-' + Date.now(),
        renotify: true
      });
    });

    if (Notification.permission === 'default') {
      Notification.requestPermission().then(function(result) {
        if (result === 'granted') getFCMToken(reg);
      });
    } else if (Notification.permission === 'granted') {
      getFCMToken(reg);
    }
  }).catch(function(err) {
    console.error('SW error:', err);
  });
}

function getFCMToken(reg) {
  fbMessaging.getToken({
    vapidKey: 'BH9Y0WkZEhPuA_xn-xz20dF7tlRQFjhGmeNg1wHpa8YyMIVN3t_lDy_ZYhL4x_yH6-XW-Xd3mtfItGVHPtqNVXg',
    serviceWorkerRegistration: reg
  }).then(function(token) {
    if (token) {
      fcmToken = token;
      localStorage.setItem('tm_fcm_token', token);
    }
  }).catch(function(err) {
    console.error('FCM token error:', err);
  });
}

// Thursday check (local fallback, works when page is open)
function checkThursdayNotification() {
  try {
    var now = new Date();
    if (now.getDay() !== 4) return;
    var tasks = loadTasks();
    var pending = tasks.filter(function(t) { return !t.done && !t.recurring; });
    if (!pending.length) return;
    var lastNotif = localStorage.getItem('tm_last_thu_notif');
    var todayStr = localDateStr(now);
    if (lastNotif === todayStr) return;
    localStorage.setItem('tm_last_thu_notif', todayStr);
    if (swRegistration) {
      swRegistration.showNotification('×ª×–×›×•×¨×ª ×©×‘×•×¢×™×ª - ×™×•× ×—××™×©×™', {
        body: '×™×© ×œ×š ' + pending.length + ' ××©×™××•×ª ×©×œ× ×”×•×©×œ××• ×”×©×‘×•×¢',
        vibrate: [200, 100, 200]
      });
    }
  } catch(e) {}
}

// ---- App Icon + Manifest ----
function generateIcon(size) {
  var c = document.createElement('canvas');
  c.width = c.height = size;
  var ctx = c.getContext('2d');
  var r = size * 0.18;
  ctx.fillStyle = '#FFCFDE';
  ctx.beginPath();
  ctx.moveTo(r, 0);
  ctx.lineTo(size - r, 0);
  ctx.quadraticCurveTo(size, 0, size, r);
  ctx.lineTo(size, size - r);
  ctx.quadraticCurveTo(size, size, size - r, size);
  ctx.lineTo(r, size);
  ctx.quadraticCurveTo(0, size, 0, size - r);
  ctx.lineTo(0, r);
  ctx.quadraticCurveTo(0, 0, r, 0);
  ctx.closePath();
  ctx.fill();
  ctx.strokeStyle = '#c0467e';
  ctx.lineWidth = size * 0.08;
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';
  ctx.beginPath();
  ctx.moveTo(size * 0.25, size * 0.52);
  ctx.lineTo(size * 0.42, size * 0.7);
  ctx.lineTo(size * 0.75, size * 0.3);
  ctx.stroke();
  return c.toDataURL('image/png');
}

try {
  var icon192 = generateIcon(192);
  var icon512 = generateIcon(512);
  var appleIcon = document.createElement('link');
  appleIcon.rel = 'apple-touch-icon';
  appleIcon.href = icon192;
  document.head.appendChild(appleIcon);
  var favicon = document.createElement('link');
  favicon.rel = 'icon';
  favicon.type = 'image/png';
  favicon.href = icon192;
  document.head.appendChild(favicon);
  var manifest = {
    name: '×× ×”×œ ××©×™××•×ª',
    short_name: '××©×™××•×ª',
    start_url: './',
    display: 'standalone',
    background_color: '#FFCFDE',
    theme_color: '#FFCFDE',
    dir: 'rtl',
    lang: 'he',
    icons: [
      { src: icon192, sizes: '192x192', type: 'image/png' },
      { src: icon512, sizes: '512x512', type: 'image/png', purpose: 'any' }
    ]
  };
  var manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
  var manifestLink = document.createElement('link');
  manifestLink.rel = 'manifest';
  manifestLink.href = URL.createObjectURL(manifestBlob);
  document.head.appendChild(manifestLink);
} catch(e) {}

checkThursdayNotification();
setInterval(checkThursdayNotification, 3600000);
initFCM();

// ---- Init ----
renderTasks();
renderWeek();
</script>
</body>
</html>
